<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å‹è‹±æ–‡å–®å­—æŠ½æŸ¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@400;700&display=swap');
        :root {
            /* é¡è‰²è®Šæ•¸ */
            --bg-color: #CAC6BD;
            --btn-color: #BB9A88;
            --quiz-color: #979D6E; /* é¡Œç›®èƒŒæ™¯è‰² */
            --correct-color: #F46464; /* æ­£ç¢ºç­”æ¡ˆé¡è‰² (ç´…è‰²ç³») */
            --incorrect-color: #B5CEBA; /* éŒ¯èª¤ç­”æ¡ˆé¡è‰² (ç¶ è‰²ç³») */
            --skip-color: #F99769; /* è·³éç­”æ¡ˆé¡è‰² (æ©˜è‰²ç³») */
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-custom {
            background-color: var(--btn-color);
        }
        .btn-custom:hover {
            background-color: #a48777; 
        }
        .quiz-card-theme {
            background-color: var(--quiz-color);
            border-color: var(--quiz-color); 
        }
        /* é¿å…ä½¿ç”¨ Tailwind æä¾›çš„é¡è‰²é¡åˆ¥ä¾†é¿å…è¦†è“‹ */
        .correct-feedback-bg { background-color: var(--correct-color); }
        .correct-feedback-text { color: var(--correct-color); }
        .incorrect-feedback-bg { background-color: var(--incorrect-color); }
        .incorrect-feedback-text { color: var(--incorrect-color); }
        .skip-feedback-bg { background-color: var(--skip-color); }
        .skip-feedback-text { color: var(--skip-color); }

        /* è¼¸å…¥æ¡†çš„è‡ªå‹•è£œé½ŠèƒŒæ™¯è‰²è™•ç† */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0px 1000px white inset !important;
        }
    </style>
</head>
<body class="p-4">

    <div class="w-full max-w-lg mx-auto bg-white shadow-2xl rounded-3xl p-6 sm:p-10 border-t-8 border-quiz-card-theme">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">æ™ºæ…§å‹å–®å­—æŠ½æŸ¥æŒ‘æˆ°</h1>
        <p id="mode-info" class="text-sm text-gray-500 mb-6 text-center">æ­£åœ¨é©—è­‰èº«åˆ†ä¸¦åŒæ­¥æ•¸æ“š...</p>

        <div class="flex justify-between items-center text-lg font-semibold text-gray-700 mb-6 p-3 bg-gray-50 rounded-xl shadow-inner">
            <span>åˆ†æ•¸ï¼š<span id="score-display" class="text-blue-600">0</span></span>
            <span>ç¸½é¡Œæ•¸ï¼š<span id="total-questions-display" class="text-blue-600">0</span></span>
        </div>

        <div id="quiz-card" class="h-48 flex flex-col justify-center items-center text-white rounded-2xl p-6 shadow-xl border-4 border-quiz-card-theme transition duration-300 quiz-card-theme">
            <p id="quiz-direction" class="text-sm opacity-80 mb-2"></p>
            <p id="quiz-question" class="text-4xl font-bold leading-snug text-center">Loading...</p>
        </div>

        <div id="correct-answer-display" class="text-center text-xl font-bold mt-4 p-3 bg-yellow-50 text-gray-800 rounded-xl border border-yellow-300 hidden">
            </div>

        <div class="mt-6">
            <input type="text" id="answer-input"
                        class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-400 focus:border-blue-400 transition duration-150 shadow-md text-lg"
                        placeholder="è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ..."
                        autocomplete="off">

            <div id="feedback-message" class="text-center font-bold text-lg mt-4 hidden"></div>

            <div class="flex space-x-4 mt-4">
                <button id="submit-button"
                        class="flex-1 btn-custom text-white font-medium py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] active:scale-[0.99]"
                        onclick="handleSubmitOrSkip()">
                    é€å‡º
                </button>
                
                <button id="next-button"
                        class="flex-1 btn-custom text-white font-medium py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] active:scale-[0.99] hidden"
                        onclick="nextQuestion()">
                    ä¸‹ä¸€é¡Œ
                </button>
            </div>
            <p id="user-id-display" class="text-xs text-gray-400 mt-4 text-center break-words">User ID: N/A</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // æ ¸å¿ƒå–®å­—åº« (ç”¨æ–¼åˆå§‹åŒ–)
        const BASE_VOCABULARY = [
            { word: "apple", meaning: "è˜‹æœ", pos: "(n.)" },
            { word: "book", meaning: "æ›¸æœ¬", pos: "(n.)" },
            { word: "house", meaning: "æˆ¿å­", pos: "(n.)" },
            { word: "run", meaning: "è·‘", pos: "(v.)" },
            { word: "happy", meaning: "å¿«æ¨‚çš„", pos: "(adj.)" },
            { word: "tree", meaning: "æ¨¹", pos: "(n.)" },
            { word: "water", meaning: "æ°´", pos: "(n.)" },
            { word: "time", meaning: "æ™‚é–“", pos: "(n.)" },
            { word: "family", meaning: "å®¶åº­", pos: "(n.)" },
            { word: "understand", meaning: "ç†è§£", pos: "(v.)" },
            { word: "computer", meaning: "é›»è…¦", pos: "(n.)" },
            { word: "science", meaning: "ç§‘å­¸", pos: "(n.)" },
            { word: "music", meaning: "éŸ³æ¨‚", pos: "(n.)" },
            { word: "travel", meaning: "æ—…è¡Œ", pos: "(v.)" },
            { word: "beautiful", meaning: "ç¾éº—çš„", pos: "(adj.)" },
            { word: "develop", meaning: "ç™¼å±•", pos: "(v.)" },
            { word: "success", meaning: "æˆåŠŸ", pos: "(n.)" },
            { word: "system", meaning: "ç³»çµ±", pos: "(n.)" },
            { word: "example", meaning: "ç¯„ä¾‹", pos: "(n.)" },
            { word: "global", meaning: "å…¨çƒçš„", pos: "(adj.)" },
            { word: "knowledge", meaning: "çŸ¥è­˜", pos: "(n.)" },
            { word: "important", meaning: "é‡è¦çš„", pos: "(adj.)" },
            { word: "language", meaning: "èªè¨€", pos: "(n.)" },
            { word: "believe", meaning: "ç›¸ä¿¡", pos: "(v.)" },
            { word: "difference", meaning: "å·®ç•°", pos: "(n.)" },
            { word: "algorithm", meaning: "æ¼”ç®—æ³•", pos: "(n.)" },
            { word: "protocol", meaning: "å”å®š", pos: "(n.)" },
            { word: "efficient", meaning: "æ•ˆç‡é«˜çš„", pos: "(adj.)" },
            { word: "design", meaning: "è¨­è¨ˆ", pos: "(n./v.)" },
            { word: "marketing", meaning: "è¡ŒéŠ·", pos: "(n.)" },
            { word: "creative", meaning: "æœ‰å‰µæ„çš„", pos: "(adj.)" },
            { word: "emotion", meaning: "æƒ…ç·’", pos: "(n.)" },
            { word: "pattern", meaning: "æ¨¡å¼", pos: "(n.)" },
            { word: "analyze", meaning: "åˆ†æ", pos: "(v.)" },
            { word: "solution", meaning: "è§£æ±ºæ–¹æ¡ˆ", pos: "(n.)" },
            { word: "execute", meaning: "åŸ·è¡Œ", pos: "(v.)" },
            { word: "insight", meaning: "æ´å¯ŸåŠ›", pos: "(n.)" },
            { word: "goal", meaning: "ç›®æ¨™", pos: "(n.)" },
        ];

        // --- Firebase å°ˆæ¡ˆé…ç½® (ä½¿ç”¨æä¾›çš„å…¨åŸŸè®Šæ•¸) ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ç¢ºä¿ initialAuthToken æ˜¯å­—ä¸²æˆ– nullï¼Œè€Œé undefined
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --------------------------------------------------------

        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let db;
        let auth;
        let userId = 'N/A';
        let firestoreReady = false;
        
        let currentWord = null;
        let currentDirection = ''; 
        let score = 0;
        let totalQuestions = 0;
        let isQuestionAnswered = false;
        let initialAuthCheckComplete = false;
        
        // å„²å­˜å¾ Firestore è¼‰å…¥æˆ–åˆå§‹åŒ–çš„å¸¶æœ‰çµ±è¨ˆæ•¸æ“šçš„å–®å­—åˆ—è¡¨
        let fullVocabularyStats = []; 

        // --- UI å…ƒç´  ---
        const questionDisplay = document.getElementById('quiz-question');
        const directionDisplay = document.getElementById('quiz-direction');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('submit-button');
        const nextButton = document.getElementById('next-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const scoreDisplay = document.getElementById('score-display');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');
        const quizCard = document.getElementById('quiz-card');
        const answerDisplay = document.getElementById('correct-answer-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const modeInfoDisplay = document.getElementById('mode-info');

        /**
         * å–å¾— Firestore æ–‡ä»¶åƒè€ƒè·¯å¾‘ (ç§æœ‰è³‡æ–™)
         */
        function getStatsDocRef() {
            // Path: /artifacts/{appId}/users/{userId}/vocabulary_stats/global
            if (!db || !userId || appId === 'default-app-id') {
                console.error("Database, User ID, or App ID is not defined for doc reference.");
                return null;
            }
            return doc(db, 'artifacts', appId, 'users', userId, 'vocabulary_stats', 'global');
        }

        /**
         * å•Ÿå‹•ç´”é›¢ç·šæ¨¡å¼ï¼ˆç•¶ Firebase ç„¡æ³•ä½¿ç”¨æ™‚ï¼‰
         */
        function initOffline() {
            modeInfoDisplay.textContent = 'â— é›¢ç·šæ¨¡å¼ã€‚ç„¡æ³•å„²å­˜é€²åº¦ã€‚';
            userIdDisplay.textContent = 'User ID: OFFLINE_MODE (ç„¡æ³•å„²å­˜ç´€éŒ„)';
            firestoreReady = false;
            // ä½¿ç”¨ç„¡çµ±è¨ˆæ•¸æ“šçš„éœæ…‹å–®å­—åº«
            fullVocabularyStats = BASE_VOCABULARY.map(w => ({
                ...w,
                correctCount: 0,
                incorrectCount: 0,
            }));
            
            if (fullVocabularyStats.length > 0) {
                // ç¢ºä¿åœ¨é›¢ç·šæ¨¡å¼ä¸‹ä¹Ÿèƒ½å•Ÿå‹• UI
                if (!currentWord) {
                   selectNextQuestion();
                }
            } else {
                questionDisplay.textContent = "å–®å­—åº«ç‚ºç©ºï¼Œç„¡æ³•é–‹å§‹æ¸¬é©—ã€‚";
            }
        }

        /**
         * è¼‰å…¥ä¸¦ç›£è½ Firestore æ•¸æ“š
         */
        function loadAndListenToData() {
            const docRef = getStatsDocRef();
            if (!docRef) {
                console.error("Failed to get document reference.");
                return initOffline();
            }
            
            // è¨­ç½®å³æ™‚ç›£è½
            onSnapshot(docRef, (docSnap) => {
                let data;
                if (docSnap.exists()) {
                    data = docSnap.data();
                    console.log("Current data from Firestore:", data);
                    
                    score = data.score || 0;
                    totalQuestions = data.totalQuestions || 0;
                    
                    // è¼‰å…¥å–®å­—çµ±è¨ˆ
                    const vocabMap = (data.vocabulary || []).reduce((map, w) => {
                        map[w.word] = w;
                        return map;
                    }, {});

                    // ä½¿ç”¨ BASE_VOCABULARY ç‚ºè—åœ–ï¼Œåˆä½µ Firestore ä¸­çš„çµ±è¨ˆæ•¸æ“š
                    fullVocabularyStats = BASE_VOCABULARY.map(baseWord => {
                        const stats = vocabMap[baseWord.word];
                        return {
                            ...baseWord,
                            correctCount: stats?.correctCount || 0,
                            incorrectCount: stats?.incorrectCount || 0,
                        };
                    });
                } else {
                    console.log("No existing stats found. Initializing new stats and saving.");
                    // åˆå§‹åŒ–ä¸¦å„²å­˜é è¨­çµ±è¨ˆçµæ§‹
                    fullVocabularyStats = BASE_VOCABULARY.map(w => ({
                        ...w,
                        correctCount: 0,
                        incorrectCount: 0,
                    }));
                    saveData(); // ç«‹å³å„²å­˜åˆå§‹ç‹€æ…‹ (setDoc æœƒè§¸ç™¼ onSnapshot å†æ¬¡æ›´æ–°)
                }

                // æ›´æ–° UI é¡¯ç¤º
                scoreDisplay.textContent = score;
                totalQuestionsDisplay.textContent = totalQuestions;

                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œé–‹å§‹æ¸¬é©—
                if (!currentWord) {
                    selectNextQuestion();
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                // ç›£è½å¤±æ•—é€šå¸¸æ„å‘³è‘—æ¬Šé™å•é¡Œæˆ–å…¶ä»–éŒ¯èª¤ï¼Œé€€å›é›¢ç·šæ¨¡å¼
                initOffline(); 
            });
        }

        /**
         * å°‡ç•¶å‰ç‹€æ…‹å„²å­˜åˆ° Firestore
         */
        async function saveData() {
            if (!firestoreReady) {
                console.warn("Firestore not ready. Cannot save data.");
                return;
            }
            const docRef = getStatsDocRef();
            if (!docRef) return;
            
            const dataToSave = {
                score: score,
                totalQuestions: totalQuestions,
                // å„²å­˜æ‰€æœ‰å–®å­—çš„çµ±è¨ˆæ•¸æ“š
                vocabulary: fullVocabularyStats.map(w => ({
                    word: w.word,
                    meaning: w.meaning,
                    pos: w.pos,
                    correctCount: w.correctCount || 0,
                    incorrectCount: w.incorrectCount || 0,
                })),
                lastUpdated: new Date().toISOString()
            };
            try {
                // ä½¿ç”¨ setDoc + merge: true 
                await setDoc(docRef, dataToSave, { merge: true });
                console.log("Data saved successfully.");
            } catch (e) {
                console.error("Error writing document: ", e);
            }
        }

        /**
         * æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• (ä¸»å‡½æ•¸)
         * ä¿®æ­£èªè­‰é‚è¼¯ï¼Œé¿å…åœ¨éåŒæ­¥ç™»å…¥å®Œæˆå‰èª¤åˆ¤å¤±æ•—ã€‚
         */
        async function initApp() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config is empty. Proceeding with anonymous sign-in attempt.");
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('error'); // æ¸›å°‘æ§åˆ¶å°å™ªéŸ³

                // ä½¿ç”¨ onAuthStateChanged ç›£è½å™¨ä¾†é©…å‹•æ‰€æœ‰å¾ŒçºŒæµç¨‹
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // 1. èº«ä»½é©—è­‰æˆåŠŸ
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        firestoreReady = true;

                        modeInfoDisplay.textContent = 'ğŸš€ é€£ç·šæˆåŠŸï¼æ‚¨çš„åˆ†æ•¸å’Œé€²åº¦å°‡è¢«è‡ªå‹•å„²å­˜ã€‚';
                        
                        // 2. è¼‰å…¥æ•¸æ“š
                        loadAndListenToData(); 
                    } else {
                        // 3. å°šæœªç™»å…¥æˆ–ç™»å‡º
                        if (!initialAuthCheckComplete) {
                            // é¦–æ¬¡æª¢æŸ¥æ™‚ï¼Œå˜—è©¦ç™»å…¥
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (e) {
                                // ç™»å…¥å¤±æ•—ï¼šç«‹å³åˆ‡æ›è‡³é›¢ç·šæ¨¡å¼
                                console.error("Sign-in attempt failed, falling back to OFFLINE_MODE:", e);
                                initOffline(); 
                            }
                        } else {
                            // éé¦–æ¬¡æª¢æŸ¥ï¼Œä¸”æ²’æœ‰ user (å¯èƒ½æ˜¯ç™»å‡ºæˆ–é¦–æ¬¡å˜—è©¦å¤±æ•—å¾Œ)
                            if (!firestoreReady) {
                                console.error("Auth session not established. Maintaining OFFLINE_MODE.");
                            }
                        }
                    }
                    initialAuthCheckComplete = true; // æ¨™è¨˜é¦–æ¬¡æª¢æŸ¥å®Œæˆ
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                initOffline();
            }
        }

        /**
         * é¸æ“‡ä¸‹ä¸€é¡Œçš„å–®å­—èˆ‡æŠ½æŸ¥æ–¹å‘
         */
        function selectNextQuestion() {
            if (fullVocabularyStats.length === 0) {
                questionDisplay.textContent = "å–®å­—åº«ç‚ºç©ºã€‚";
                return;
            }

            // --- æ™ºæ…§é¸é¡Œé‚è¼¯ (åŠ æ¬Šéš¨æ©Ÿ) ---
            let totalWeight = 0;
            const weightedWords = fullVocabularyStats.map(word => {
                const C = word.correctCount || 0;
                const I = word.incorrectCount || 0;
                let weight;

                if (C === 0 && I === 0) {
                    // 1. å…¨æ–°å–®å­—ï¼šçµ¦äºˆé«˜æ¬Šé‡ (5)ï¼Œç¢ºä¿æ–°å–®å­—èƒ½å„ªå…ˆè¢«æŠ½åˆ°
                    weight = 5; 
                } else {
                    // 2. å·²å­¸ç¿’å–®å­—ï¼šå…¬å¼: Max(1, 1 + 5*I - 1*C) - ç­”éŒ¯è¶Šå¤šï¼Œæ¬Šé‡è¶Šé«˜
                    weight = Math.max(1, 1 + (5 * I) - C);
                }
                
                totalWeight += weight;
                return { word: word, weight: weight };
            });

            // éš¨æ©Ÿé¸æ“‡ä¸€å€‹å–®å­— (è¼ªç›¤æ³•)
            let randomTarget = Math.random() * totalWeight;
            let selectedWord = null;

            for (const item of weightedWords) {
                randomTarget -= item.weight;
                if (randomTarget <= 0) {
                    selectedWord = item.word;
                    break;
                }
            }
            
            // ç¢ºä¿é¸åˆ°å–®å­—
            currentWord = selectedWord || fullVocabularyStats[Math.floor(Math.random() * fullVocabularyStats.length)];
            // --- æ™ºæ…§é¸é¡Œé‚è¼¯çµæŸ ---
            
            // 2. éš¨æ©Ÿæ±ºå®šæ–¹å‘ (è‹±ç¿»ä¸­ E2C, ä¸­ç¿»è‹± C2E)
            currentDirection = Math.random() < 0.5 ? 'E2C' : 'C2E';

            // 3. æ¸²æŸ“é¡Œç›®ä¸¦é‡è¨­ UI ç‹€æ…‹
            renderQuestion(currentWord);

            answerInput.value = '';
            answerInput.disabled = false;
            submitButton.disabled = false;
            submitButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            feedbackMessage.classList.add('hidden');
            answerDisplay.classList.add('hidden');
            quizCard.classList.remove('correct-feedback-bg', 'incorrect-feedback-bg', 'skip-feedback-bg'); 
            quizCard.classList.add('quiz-card-theme'); 
            isQuestionAnswered = false;
            
            answerInput.focus();
        }

        /**
         * æ¸²æŸ“ç•¶å‰é¡Œç›®åˆ°ç•«é¢ä¸Š
         */
        function renderQuestion(wordObject) {
            const posDisplay = wordObject.pos ? `<span class="text-2xl opacity-80 font-normal">${wordObject.pos}</span>` : '';
            const currentDirectionText = currentDirection === 'E2C' ? 'ã€è‹±ç¿»ä¸­ã€‘' : 'ã€ä¸­ç¿»è‹±ã€‘';
            
            if (currentDirection === 'E2C') {
                directionDisplay.textContent = currentDirectionText;
                questionDisplay.innerHTML = `${wordObject.word} ${posDisplay}`; 
                answerInput.placeholder = 'è«‹è¼¸å…¥ä¸­æ–‡è§£é‡‹...';
            } else {
                directionDisplay.textContent = currentDirectionText; 
                questionDisplay.innerHTML = `${wordObject.meaning} ${posDisplay}`; 
                answerInput.placeholder = 'è«‹è¼¸å…¥è‹±æ–‡å–®å­—...';
            }
        }

        /**
         * è™•ç† é€å‡ºç­”æ¡ˆ / è·³é é‚è¼¯
         */
        window.handleSubmitOrSkip = function() {
            if (isQuestionAnswered || !currentWord) return;

            const userAnswer = answerInput.value.trim();
            const currentWordStat = currentWord;
            let correctAnswer;

            if (currentDirection === 'E2C') {
                correctAnswer = currentWordStat.meaning; 
            } else {
                correctAnswer = currentWordStat.word;   
            }

            const isSkipped = userAnswer === '';
            const isCorrect = isSkipped ? false : validateAnswer(userAnswer, correctAnswer, currentDirection);

            totalQuestions++;
            
            isQuestionAnswered = true;
            answerInput.disabled = true;
            submitButton.classList.add('hidden');
            nextButton.classList.remove('hidden');
            feedbackMessage.classList.remove('hidden');
            answerDisplay.classList.remove('hidden');
            quizCard.classList.remove('quiz-card-theme');

            // 1. æ›´æ–°å–®å­—çµ±è¨ˆ
            const wordToUpdate = fullVocabularyStats.find(w => w.word === currentWordStat.word);
            if (wordToUpdate) {
                if (isCorrect) {
                    score++;
                    wordToUpdate.correctCount = (wordToUpdate.correctCount || 0) + 1;
                } else {
                    // ç„¡è«–æ˜¯ç­”éŒ¯ (isSkipped=false) æˆ–è·³é (isSkipped=true)ï¼Œéƒ½è¨ˆå…¥ incorrectCount (å¾…è¤‡ç¿’)
                    wordToUpdate.incorrectCount = (wordToUpdate.incorrectCount || 0) + 1;
                }
            }


            // 2. å„²å­˜æ•¸æ“š (æœƒè§¸ç™¼ onSnapshot æ›´æ–° UI)
            if (firestoreReady) {
                saveData();
            } else {
                // é›¢ç·šæ¨¡å¼æ‰‹å‹•æ›´æ–°åˆ†æ•¸
                scoreDisplay.textContent = score;
                totalQuestionsDisplay.textContent = totalQuestions;
            }

            // 3. é¡¯ç¤ºçµæœ
            if (isSkipped) {
                feedbackMessage.textContent = 'â­ï¸ å·²è·³éï¼Œè«‹çœ‹ä¸‹æ–¹æ­£ç¢ºç­”æ¡ˆã€‚';
                feedbackMessage.classList.remove('correct-feedback-text', 'incorrect-feedback-text'); 
                feedbackMessage.classList.add('skip-feedback-text');
                quizCard.classList.add('skip-feedback-bg');
            } else if (isCorrect) {
                feedbackMessage.textContent = 'âœ… å¤ªæ£’äº†ï¼Œç­”æ¡ˆæ­£ç¢ºï¼';
                feedbackMessage.classList.remove('incorrect-feedback-text', 'skip-feedback-text');
                feedbackMessage.classList.add('correct-feedback-text'); 
                quizCard.classList.add('correct-feedback-bg'); 
            } else {
                feedbackMessage.textContent = 'âŒ éŒ¯èª¤ï¼è«‹çœ‹ä¸‹æ–¹æ­£ç¢ºç­”æ¡ˆã€‚';
                feedbackMessage.classList.remove('correct-feedback-text', 'skip-feedback-text');
                feedbackMessage.classList.add('incorrect-feedback-text');
                quizCard.classList.add('incorrect-feedback-bg');
            }

            // 4. é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            const correctPOS = currentWordStat.pos;
            // é‡å°ä¸­ç¿»è‹±ï¼Œç­”æ¡ˆæ˜¯è‹±æ–‡å–®å­—ï¼Œæ‰€ä»¥é¡¯ç¤ºå–®å­—æœ¬èº«ï¼›é‡å°è‹±ç¿»ä¸­ï¼Œç­”æ¡ˆæ˜¯ä¸­æ–‡æ„æ€ã€‚
            const displayAnswer = currentDirection === 'C2E' ? currentWordStat.word : currentWordStat.meaning;
            
            answerDisplay.innerHTML = `æ­£ç¢ºç­”æ¡ˆï¼š<span class="font-black">${displayAnswer}</span> <span class="text-base font-normal opacity-70">${correctPOS}</span>`;

            nextButton.focus();
        }

        /**
         * é€²è¡Œä¸‹ä¸€é¡Œ
         */
        window.nextQuestion = function() {
            selectNextQuestion();
        }

        /**
         * ç­”æ¡ˆé©—è­‰é‚è¼¯ (å·²ä¿®æ”¹ç‚ºæ›´å¯¬é¬†çš„é©—è­‰æ¨™æº–)
         * å®¹å¿åº¦è¦å‰‡ï¼š
         * 1. C2E (ä¸­ç¿»è‹±): å®¹å¿ 1-2 å€‹å­—æ¯çš„æ‹¼å¯«éŒ¯èª¤ï¼ˆåŸºæ–¼é•·åº¦ï¼‰ã€‚
         * 2. E2C (è‹±ç¿»ä¸­): å®¹å¿é¡å¤–è©èªï¼Œåªè¦åŒ…å«æ­£ç¢ºç­”æ¡ˆçš„æ ¸å¿ƒä¸­æ–‡è§£é‡‹å³ç®—æ­£ç¢ºã€‚
         */
        function validateAnswer(user, correct, direction) {
            if (user.trim() === '') return false; // ç¢ºä¿éç©º

            if (direction === 'C2E') {
                // 1. ä¸­ç¿»è‹± (è¼¸å…¥ï¼šè‹±æ–‡å–®å­—)
                const userLower = user.toLowerCase().trim();
                const correctLower = correct.toLowerCase().trim();

                // a. ç²¾ç¢ºåŒ¹é…
                if (userLower === correctLower) return true;

                // b. æ¨¡ç³ŠåŒ¹é… (åŸºæ–¼å–®å­—é•·åº¦çµ¦äºˆæ‹¼å¯«éŒ¯èª¤å®¹å¿åº¦)
                const maxLength = Math.max(userLower.length, correctLower.length);
                // å®¹å¿åº¦è¨ˆç®—ï¼šå–®å­—é•·åº¦ <= 4 å®¹å¿ 1 å€‹éŒ¯èª¤ï¼›å–®å­—é•·åº¦ > 4 å®¹å¿ 2 å€‹éŒ¯èª¤
                const tolerance = maxLength <= 4 ? 1 : 2;

                // æª¢æŸ¥é•·åº¦å·®ç•°æ˜¯å¦åœ¨å®¹å¿ç¯„åœå…§
                if (Math.abs(userLower.length - correctLower.length) <= tolerance) {
                    
                    // ******* ç°¡åŒ–ç›¸ä¼¼åº¦æª¢æŸ¥ (æ›¿ä»£ Levenshtein) *******
                    // æª¢æŸ¥ä½¿ç”¨è€…è¼¸å…¥æ˜¯å¦åŒ…å«æ­£ç¢ºç­”æ¡ˆçš„**å‰Nå€‹å­—æ¯**
                    const checkLength = Math.min(3, correctLower.length);
                    // æª¢æŸ¥æ­£ç¢ºç­”æ¡ˆçš„å‰Nå€‹å­—æ¯æ˜¯å¦å‡ºç¾åœ¨ä½¿ç”¨è€…è¼¸å…¥ä¸­ï¼Œä¸”é•·åº¦ç›¸ä¼¼
                    if (userLower.includes(correctLower.substring(0, checkLength))) {
                        return true;
                    }
                    // ***********************************************
                }
                
                return false;

            } else {
                // 2. è‹±ç¿»ä¸­ (è¼¸å…¥ï¼šä¸­æ–‡è§£é‡‹)
                // åš´æ ¼æ¸…æ´—ï¼šåªä¿ç•™ä¸­æ–‡å­—ã€è‹±æ–‡å­—ã€æ•¸å­—
                // æ¸…ç†æ¨™é»ç¬¦è™Ÿå’Œéæ ¸å¿ƒå­—ç¬¦
                const cleanUser = user.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, "").trim();
                const cleanCorrect = correct.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, "").trim();

                // a. ç²¾ç¢ºåŒ¹é… (æ¸…æ´—å¾Œ)
                if (cleanUser === cleanCorrect) return true;

                // b. æ ¸å¿ƒè©å½™åŒ…å«æª¢æŸ¥ (æ›´å¯¬é¬†çš„æ¨™æº–)
                // åªè¦ä¸€æ–¹åŒ…å«å¦ä¸€æ–¹ï¼Œä¸”æ­£ç¢ºç­”æ¡ˆé•·åº¦å¤§æ–¼1ï¼Œå³ç®—æ­£ç¢º (æ’é™¤å–®ä¸€å­—å…ƒçš„èª¤åˆ¤)
                if (cleanCorrect.length > 1 && (cleanUser.includes(cleanCorrect) || cleanCorrect.includes(cleanUser))) {
                    return true;
                }

                return false;
            }
        }
        
        /**
         * åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
         */
        function setupListeners() {
            // å…è¨±åœ¨è¼¸å…¥æ¡†ä¸­æŒ‰ Enter éµè§¸ç™¼é€å‡ºæˆ–ä¸‹ä¸€é¡Œ
            answerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!isQuestionAnswered) {
                        window.handleSubmitOrSkip();
                    } else {
                        window.nextQuestion();
                    }
                }
            });
        }

        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        window.onload = () => {
             setupListeners(); // å…ˆè¨­ç½®ç›£è½å™¨ï¼Œç¢ºä¿ Enter éµå¯ç”¨
             initApp();
        };
    </script>
</body>
</html>
