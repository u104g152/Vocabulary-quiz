<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧型英文單字抽查</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Firebase 模組 -->
    <script type="module">
        // 確保在模組載入時，將所有 Firebase 函式暴露給 window
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, setDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 將必要的 Firebase 函數暴露給全域範圍
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, getDocs, setDoc, doc, serverTimestamp, setLogLevel
        };
    </script>
    <!-- 設定 Inter 字體與自訂樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@400;700&display=swap');
        :root {
            /* 使用者指定的顏色變數 */
            --bg-color: #CAC6BD;
            --btn-color: #BB9A88;
            --quiz-color: #979D6E; /* 題目背景色 */
            --correct-color: #F46464; /* 正確答案顏色 */
            --incorrect-color: #B5CEBA; /* 錯誤答案顏色 (新的) */
            --skip-color: #F99769; /* 跳過答案顏色 (新的) */
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* 自訂按鈕顏色 */
        .btn-custom {
            background-color: var(--btn-color);
        }
        .btn-custom:hover {
            background-color: #a48777; /* 稍微深一點的 hover 效果 */
        }
        /* 測驗卡片顏色 (預設/題目) */
        .quiz-card-theme {
            background-color: var(--quiz-color);
            border-color: var(--quiz-color); 
        }
        /* 正確答案反饋的樣式 (#F46464) */
        .correct-feedback-bg {
            background-color: var(--correct-color);
        }
        .correct-feedback-text {
            color: var(--correct-color);
        }
        /* 錯誤答案反饋的樣式 (#B5CEBA) */
        .incorrect-feedback-bg {
            background-color: var(--incorrect-color);
        }
        .incorrect-feedback-text {
            color: var(--incorrect-color);
        }
        /* 跳過答案反饋的樣式 (#F99769) */
        .skip-feedback-bg {
            background-color: var(--skip-color);
        }
        .skip-feedback-text {
            color: var(--skip-color);
        }
    </style>
</head>
<body class="p-4">

    <!-- 載入畫面 -->
    <div id="loading-spinner" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-white"></div>
        <p class="text-white text-lg ml-4">載入單字庫與學習紀錄中...</p>
    </div>

    <!-- 主容器 - 專注於單一測驗卡片 -->
    <div class="w-full max-w-lg mx-auto bg-white shadow-2xl rounded-3xl p-6 sm:p-10 border-t-8 border-quiz-card-theme">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">智慧型單字抽查挑戰</h1>
        <p class="text-sm text-gray-500 mb-6 text-center">您的學習紀錄會自動儲存與同步！</p>

        <!-- 總分數與進度 -->
        <div class="flex justify-between items-center text-lg font-semibold text-gray-700 mb-6 p-3 bg-gray-50 rounded-xl shadow-inner">
            <span>分數：<span id="score-display" class="text-blue-600">0</span></span>
            <span>總題數：<span id="total-questions-display" class="text-blue-600">0</span></span>
        </div>

        <!-- 測驗卡片區 -->
        <div id="quiz-card" class="h-48 flex flex-col justify-center items-center text-white rounded-2xl p-6 shadow-xl border-4 border-quiz-card-theme transition duration-300 quiz-card-theme">
            <p id="quiz-direction" class="text-sm opacity-80 mb-2"></p>
            <p id="quiz-question" class="text-4xl font-bold leading-snug text-center"></p>
        </div>

        <!-- 正確答案顯示區 (答錯或跳過時顯示) -->
        <div id="correct-answer-display" class="text-center text-xl font-bold mt-4 p-3 bg-yellow-50 text-gray-800 rounded-xl border border-yellow-300 hidden">
            <!-- 答案將顯示在這裡 -->
        </div>


        <!-- 輸入與操作區 -->
        <div class="mt-6">
            <input type="text" id="answer-input"
                   class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-400 focus:border-blue-400 transition duration-150 shadow-md text-lg"
                   placeholder="輸入您的答案..."
                   autocomplete="off">

            <!-- 答案反饋區 -->
            <div id="feedback-message" class="text-center font-bold text-lg mt-4 hidden"></div>

            <div class="flex space-x-4 mt-4">
                <button id="submit-button"
                        class="flex-1 btn-custom text-white font-medium py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] active:scale-[0.99]"
                        onclick="handleSubmitOrSkip()">
                    送出
                </button>
                
                <button id="next-button"
                        class="flex-1 btn-custom text-white font-medium py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] active:scale-[0.99] hidden"
                        onclick="nextQuestion()">
                    下一題
                </button>
            </div>
            <p id="user-id-display" class="text-xs text-gray-400 mt-4 text-center break-words">User ID: N/A</p>
        </div>
    </div>

    <!-- JavaScript 邏輯區塊 -->
    <script>
        // 核心單字庫 (用於初始載入，之後會與 Firestore 紀錄合併)
        const BASE_VOCABULARY = [
            { word: "apple", meaning: "蘋果", pos: "(n.)" },
            { word: "book", meaning: "書本", pos: "(n.)" },
            { word: "house", meaning: "房子", pos: "(n.)" },
            { word: "run", meaning: "跑", pos: "(v.)" },
            { word: "happy", meaning: "快樂的", pos: "(adj.)" },
            { word: "tree", meaning: "樹", pos: "(n.)" },
            { word: "water", meaning: "水", pos: "(n.)" },
            { word: "time", meaning: "時間", pos: "(n.)" },
            { word: "family", meaning: "家庭", pos: "(n.)" },
            { word: "understand", meaning: "理解", pos: "(v.)" },
            { word: "computer", meaning: "電腦", pos: "(n.)" },
            { word: "science", meaning: "科學", pos: "(n.)" },
            { word: "music", meaning: "音樂", pos: "(n.)" },
            { word: "travel", meaning: "旅行", pos: "(v.)" },
            { word: "beautiful", meaning: "美麗的", pos: "(adj.)" },
            { word: "develop", meaning: "發展", pos: "(v.)" },
            { word: "success", meaning: "成功", pos: "(n.)" },
            { word: "system", meaning: "系統", pos: "(n.)" },
            { word: "example", meaning: "範例", pos: "(n.)" },
            { word: "global", meaning: "全球的", pos: "(adj.)" },
            { word: "knowledge", meaning: "知識", pos: "(n.)" },
            { word: "important", meaning: "重要的", pos: "(adj.)" },
            { word: "language", meaning: "語言", pos: "(n.)" },
            { word: "believe", meaning: "相信", pos: "(v.)" },
            { word: "difference", meaning: "差異", pos: "(n.)" },
        ];

        // --- 應用程式狀態 ---
        let currentWord = null;
        let currentDirection = ''; 
        let score = 0;
        let totalQuestions = 0;
        let isQuestionAnswered = false;
        let useMockFirebase = false; // 新增：標記是否在模擬環境中執行
        
        // 儲存所有單字及其學習統計
        let fullVocabularyStats = []; 

        // --- Firebase 變數 ---
        let db, auth, userId, vocabCollectionRef;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- UI 元素 ---
        const questionDisplay = document.getElementById('quiz-question');
        const directionDisplay = document.getElementById('quiz-direction');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('submit-button');
        const nextButton = document.getElementById('next-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const scoreDisplay = document.getElementById('score-display');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');
        const quizCard = document.getElementById('quiz-card');
        const loadingSpinner = document.getElementById('loading-spinner');
        const answerDisplay = document.getElementById('correct-answer-display');
        const userIdDisplay = document.getElementById('user-id-display');

        /**
         * 初始化 Firebase, 認證並載入資料
         */
        async function initApp() {
            try {
                // --- 1. 檢查 Firebase API 模組是否載入 ---
                if (!window.firebase || !window.firebase.initializeApp) {
                    console.error("Firebase 模組未載入。直接進入 Pure Offline Mode.");
                    
                    // 立即切換到 純離線模式
                    useMockFirebase = true;
                    // 產生一個隨機 ID
                    userId = 'OFFLINE_USER_' + crypto.randomUUID(); 
                    userIdDisplay.textContent = `User ID: ${userId} (純離線模式)`;
                    
                    // 初始化單字庫
                    fullVocabularyStats = BASE_VOCABULARY.map(word => ({
                        ...word,
                        reviewWeight: 3, 
                        correctCount: 0,
                        incorrectCount: 0,
                        skipCount: 0,
                        docId: word.word
                    }));

                    selectNextQuestion(); 
                    setupListeners();
                    directionDisplay.textContent = '【離線模式】 無法儲存進度';
                    // 完成載入
                    loadingSpinner.classList.add('opacity-0', 'pointer-events-none');
                    return; // 立即退出，避免執行 Firebase 相關程式碼
                }


                // --- 2. 正常 Firebase 流程 (如果 Firebase API 已載入) ---
                let config = firebaseConfig; 
                let offlineModeReason = '';

                // 如果 Canvas 環境未提供配置 (本地運行)，啟用 Mock 模式
                if (!config) {
                    offlineModeReason = '配置遺失';
                    useMockFirebase = true;
                    // 使用虛擬配置，讓 initializeApp 順利執行
                    config = { apiKey: "mock", projectId: "mock", authDomain: "mock" }; 
                }

                if (useMockFirebase) {
                    console.warn(`WARN: Firebase configuration missing. Using mock setup. Data saving will be disabled. Reason: ${offlineModeReason}`);
                }

                window.firebase.setLogLevel('debug');
                const app = window.firebase.initializeApp(config);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);

                // 認證
                const authPromise = initialAuthToken && !useMockFirebase
                    ? window.firebase.signInWithCustomToken(auth, initialAuthToken)
                    : window.firebase.signInAnonymously(auth);

                await authPromise.catch(e => {
                    console.error("Firebase Sign-in Failed:", e);
                    // 認證失敗，但我們仍然讓 onAuthStateChanged 監聽器來處理後續狀態
                });


                // 註冊認證狀態變更監聽器
                window.firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;

                        if (!useMockFirebase) {
                            // 真實環境：設定 collection reference 並載入統計資料
                            vocabCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/vocab_stats`);
                            await loadAndMergeVocabulary();
                        } else {
                            // Mock 模式：初始化基本單字庫
                            fullVocabularyStats = BASE_VOCABULARY.map(word => ({
                                ...word, reviewWeight: 3, correctCount: 0, incorrectCount: 0, skipCount: 0, docId: word.word
                            }));
                            console.log(`單字庫載入完成 (Mock Mode)。總單字數: ${fullVocabularyStats.length}`);
                            directionDisplay.textContent = `【離線模式】 (原因: ${offlineModeReason}) 無法儲存進度`;
                        }
                       
                        selectNextQuestion(); // 開始第一回合
                        setupListeners();

                    } else {
                        // 認證失敗，但在 Mock 模式下，我們已經初始化了單字庫
                        userIdDisplay.textContent = 'User ID: N/A (Authentication Failed)';
                    }
                    loadingSpinner.classList.add('opacity-0', 'pointer-events-none');
                });
            } catch (error) {
                console.error("應用程式初始化發生嚴重錯誤，執行最終安全離線模式:", error);
                
                // 最終的安全回退機制，確保程式碼不會崩潰
                useMockFirebase = true;
                userId = 'OFFLINE_USER_' + crypto.randomUUID();
                userIdDisplay.textContent = `User ID: ${userId} (最終安全離線模式)`;
                fullVocabularyStats = BASE_VOCABULARY.map(word => ({
                    ...word, reviewWeight: 3, correctCount: 0, incorrectCount: 0, skipCount: 0, docId: word.word
                }));
                selectNextQuestion();
                setupListeners();
                directionDisplay.textContent = '【連線失敗】 請檢查網路或設定';
                loadingSpinner.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        /**
         * 從 Firestore 載入使用者統計資料並與基本單字庫合併
         */
        async function loadAndMergeVocabulary() {
            // 如果是 Mock 模式，則跳過 Firestore 載入
            if (useMockFirebase || !vocabCollectionRef) return;

            try {
                const snapshot = await window.firebase.getDocs(vocabCollectionRef);
                const firestoreStats = {};
                snapshot.forEach(doc => {
                    // 使用單字本身作為 key
                    firestoreStats[doc.id] = doc.data(); 
                });

                fullVocabularyStats = BASE_VOCABULARY.map(word => {
                    const stats = firestoreStats[word.word] || {};
                    return {
                        ...word,
                        // 權重: 1 (已學會), 3 (未學會/錯誤/跳過)
                        reviewWeight: stats.reviewWeight !== undefined ? stats.reviewWeight : 3, 
                        correctCount: stats.correctCount || 0,
                        incorrectCount: stats.incorrectCount || 0,
                        skipCount: stats.skipCount || 0,
                        docId: word.word // 方便儲存，使用單字作為文件 ID
                    };
                });
                console.log(`單字庫載入完成。總單字數: ${fullVocabularyStats.length}`);

            } catch (error) {
                console.error("載入或合併單字庫統計資料失敗:", error);
                // 即使失敗，仍使用 BASE_VOCABULARY 進行，但權重為 3
                fullVocabularyStats = BASE_VOCABULARY.map(word => ({
                    ...word,
                    reviewWeight: 3, 
                    correctCount: 0,
                    incorrectCount: 0,
                    skipCount: 0,
                    docId: word.word
                }));
            }
        }
        
        /**
         * 儲存單字的最新統計資料到 Firestore
         * @param {Object} wordStat - 包含 docId 和更新數據的單字統計物件
         */
        async function saveWordStat(wordStat) {
            // 如果是 Mock 模式或沒有 collection reference，則跳過儲存
            if (useMockFirebase || !vocabCollectionRef || !wordStat.docId) {
                if (useMockFirebase) {
                    console.log(`[Mock Mode] Skipped saving stats for: ${wordStat.word}`);
                }
                return;
            }

            // 只儲存持久化的欄位
            const dataToSave = {
                reviewWeight: wordStat.reviewWeight,
                correctCount: wordStat.correctCount,
                incorrectCount: wordStat.incorrectCount,
                skipCount: wordStat.skipCount,
                lastReviewed: window.firebase.serverTimestamp()
            };

            try {
                // 使用 word.word 作為文件 ID 確保唯一性
                await window.firebase.setDoc(window.firebase.doc(vocabCollectionRef, wordStat.docId), dataToSave, { merge: true });
            } catch (error) {
                console.error("儲存單字統計資料失敗:", error);
                // 不使用 alert()，只在 console 記錄
            }
        }

        /**
         * 選擇下一題的單字與抽查方向 (使用權重)
         */
        function selectNextQuestion() {
            if (fullVocabularyStats.length === 0) return;

            // 1. 建立加權選取列表
            const weightedList = [];
            fullVocabularyStats.forEach((wordStat) => {
                // 根據 reviewWeight (1 或 3) 將單字加入列表
                for (let i = 0; i < wordStat.reviewWeight; i++) {
                    weightedList.push(wordStat);
                }
            });

            // 2. 隨機選取
            const randomIndex = Math.floor(Math.random() * weightedList.length);
            currentWord = weightedList[randomIndex];

            // 3. 隨機決定方向 (英翻中 E2C, 中翻英 C2E)
            currentDirection = Math.random() < 0.5 ? 'E2C' : 'C2E';

            // 4. 渲染題目並重設 UI 狀態
            renderQuestion(currentWord);

            answerInput.value = '';
            answerInput.disabled = false;
            submitButton.disabled = false;
            submitButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            feedbackMessage.classList.add('hidden');
            answerDisplay.classList.add('hidden');
            // 移除所有反饋顏色，包括正確、錯誤和跳過的自訂類別
            quizCard.classList.remove('correct-feedback-bg', 'incorrect-feedback-bg', 'skip-feedback-bg'); 
            quizCard.classList.add('quiz-card-theme'); // 恢復主題顏色 #979D6E
            isQuestionAnswered = false;
            
            answerInput.focus();
        }

        /**
         * 渲染當前題目到畫面上
         * @param {Object} wordObject - 當前單字物件 (帶有統計數據)
         */
        function renderQuestion(wordObject) {
            const posDisplay = wordObject.pos ? `<span class="text-2xl opacity-80 font-normal">${wordObject.pos}</span>` : '';
            let currentDirectionText = currentDirection === 'E2C' ? '【英翻中】' : '【中翻英】';
            
            // 如果是離線模式，加上警告
            if (useMockFirebase) {
                 currentDirectionText += ' (無法儲存進度)';
            }

            if (currentDirection === 'E2C') {
                // 英翻中
                directionDisplay.textContent = currentDirectionText;
                questionDisplay.innerHTML = `${wordObject.word} ${posDisplay}`; // 顯示英文單字和詞性
                answerInput.placeholder = '請輸入中文解釋...';
            } else {
                // 中翻英
                directionDisplay.textContent = currentDirectionText; 
                questionDisplay.innerHTML = `${wordObject.meaning} ${posDisplay}`; // 顯示中文解釋和詞性
                answerInput.placeholder = '請輸入英文單字...';
            }
        }

        /**
         * 處理 送出答案 / 不知道 邏輯
         */
        window.handleSubmitOrSkip = function() {
            if (isQuestionAnswered) return;

            const userAnswer = answerInput.value.trim();
            const currentWordStat = currentWord;
            let correctAnswer;

            if (currentDirection === 'E2C') {
                correctAnswer = currentWordStat.meaning; 
            } else {
                correctAnswer = currentWordStat.word;    
            }

            // 由於按鈕文字已移除「不知道」，現在判斷空輸入即為跳過
            const isSkipped = userAnswer === '';
            const isCorrect = validateAnswer(userAnswer, correctAnswer, currentDirection);

            totalQuestions++;
            totalQuestionsDisplay.textContent = totalQuestions;
            isQuestionAnswered = true;
            answerInput.disabled = true;
            submitButton.classList.add('hidden');
            nextButton.classList.remove('hidden');
            feedbackMessage.classList.remove('hidden');
            answerDisplay.classList.remove('hidden');
            quizCard.classList.remove('quiz-card-theme');


            if (isSkipped) {
                // 1. 跳過邏輯 (使用 #F99769)
                currentWordStat.skipCount++;
                currentWordStat.reviewWeight = 3; // 保持高權重
                feedbackMessage.textContent = '⏭️ 已跳過，請看下方正確答案。';
                // 移除其他文字顏色
                feedbackMessage.classList.remove('correct-feedback-text', 'incorrect-feedback-text'); 
                // 應用跳過文字顏色
                feedbackMessage.classList.add('skip-feedback-text');
                // 應用跳過卡片背景色
                quizCard.classList.add('skip-feedback-bg');
            } else if (isCorrect) {
                // 2. 答對邏輯 (使用 #F46464)
                score++;
                currentWordStat.correctCount++;
                currentWordStat.reviewWeight = 1; // 降低權重 (1/3 概率)
                scoreDisplay.textContent = score;
                feedbackMessage.textContent = '✅ 太棒了，答案正確！';
                // 移除其他文字顏色
                feedbackMessage.classList.remove('incorrect-feedback-text', 'skip-feedback-text');
                // 應用正確文字顏色
                feedbackMessage.classList.add('correct-feedback-text'); 
                // 應用正確卡片背景色
                quizCard.classList.add('correct-feedback-bg'); 
            } else {
                // 3. 答錯邏輯 (使用 #B5CEBA)
                currentWordStat.incorrectCount++;
                currentWordStat.reviewWeight = 3; // 保持高權重
                feedbackMessage.textContent = '❌ 錯誤！請看下方正確答案。';
                // 移除其他文字顏色
                feedbackMessage.classList.remove('correct-feedback-text', 'skip-feedback-text');
                // 應用錯誤文字顏色
                feedbackMessage.classList.add('incorrect-feedback-text');
                // 應用錯誤卡片背景色
                quizCard.classList.add('incorrect-feedback-bg');
            }

            // 顯示正確答案
            const correctPOS = currentWordStat.pos;
            answerDisplay.innerHTML = `正確答案：<span class="font-black">${correctAnswer}</span> <span class="text-base font-normal opacity-70">${correctPOS}</span>`;
            
            // 更新單字統計資料 (在 Mock 模式下會自動跳過儲存)
            saveWordStat(currentWordStat);

            // 讓使用者可以按 Enter 鍵進行下一題
            answerInput.focus();
        }

        /**
         * 進行下一題
         */
        window.nextQuestion = function() {
            selectNextQuestion();
        }

        /**
         * 答案驗證邏輯
         */
        function validateAnswer(user, correct, direction) {
            if (direction === 'C2E') {
                // 英文：不分大小寫
                return user.toLowerCase() === correct.toLowerCase();
            } else {
                // 中文：先清除空格，再檢查完全相等
                return user.replace(/\s/g, '') === correct.replace(/\s/g, '');
            }
        }
        
        /**
         * 初始化事件監聽器
         */
        function setupListeners() {
            // 允許在輸入框中按 Enter 鍵觸發送出或下一題
            answerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!isQuestionAnswered) {
                        handleSubmitOrSkip();
                    } else {
                        nextQuestion();
                    }
                }
            });
            // 點擊卡片跳過 (快速測試用)
            quizCard.addEventListener('click', () => {
                if (!isQuestionAnswered) {
                    handleSubmitOrSkip();
                } else {
                    nextQuestion();
                }
            });
        }

        // 應用程式啟動
        window.onload = function() {
            initApp();
        }
    </script>
</body>
</html>
