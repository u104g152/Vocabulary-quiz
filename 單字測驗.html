<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧型英文單字抽查</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設定 Inter 字體與自訂樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@400;700&display=swap');
        :root {
            /* 顏色變數 */
            --bg-color: #CAC6BD;
            --btn-color: #BB9A88;
            --quiz-color: #979D6E; /* 題目背景色 */
            --correct-color: #F46464; /* 正確答案顏色 */
            --incorrect-color: #B5CEBA; /* 錯誤答案顏色 */
            --skip-color: #F99769; /* 跳過答案顏色 */
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-custom {
            background-color: var(--btn-color);
        }
        .btn-custom:hover {
            background-color: #a48777; 
        }
        .quiz-card-theme {
            background-color: var(--quiz-color);
            border-color: var(--quiz-color); 
        }
        .correct-feedback-bg { background-color: var(--correct-color); }
        .correct-feedback-text { color: var(--correct-color); }
        .incorrect-feedback-bg { background-color: var(--incorrect-color); }
        .incorrect-feedback-text { color: var(--incorrect-color); }
        .skip-feedback-bg { background-color: var(--skip-color); }
        .skip-feedback-text { color: var(--skip-color); }
    </style>
</head>
<body class="p-4">

    <!-- 主容器 -->
    <div class="w-full max-w-lg mx-auto bg-white shadow-2xl rounded-3xl p-6 sm:p-10 border-t-8 border-quiz-card-theme">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">智慧型單字抽查挑戰</h1>
        <p id="mode-info" class="text-sm text-gray-500 mb-6 text-center">正在載入...</p>

        <!-- 總分數與進度 -->
        <div class="flex justify-between items-center text-lg font-semibold text-gray-700 mb-6 p-3 bg-gray-50 rounded-xl shadow-inner">
            <span>分數：<span id="score-display" class="text-blue-600">0</span></span>
            <span>總題數：<span id="total-questions-display" class="text-blue-600">0</span></span>
        </div>

        <!-- 測驗卡片區 -->
        <div id="quiz-card" class="h-48 flex flex-col justify-center items-center text-white rounded-2xl p-6 shadow-xl border-4 border-quiz-card-theme transition duration-300 quiz-card-theme">
            <p id="quiz-direction" class="text-sm opacity-80 mb-2"></p>
            <p id="quiz-question" class="text-4xl font-bold leading-snug text-center">Loading...</p>
        </div>

        <!-- 正確答案顯示區 -->
        <div id="correct-answer-display" class="text-center text-xl font-bold mt-4 p-3 bg-yellow-50 text-gray-800 rounded-xl border border-yellow-300 hidden">
            <!-- 答案將顯示在這裡 -->
        </div>

        <!-- 輸入與操作區 -->
        <div class="mt-6">
            <input type="text" id="answer-input"
                   class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-400 focus:border-blue-400 transition duration-150 shadow-md text-lg"
                   placeholder="輸入您的答案..."
                   autocomplete="off">

            <!-- 答案反饋區 -->
            <div id="feedback-message" class="text-center font-bold text-lg mt-4 hidden"></div>

            <div class="flex space-x-4 mt-4">
                <button id="submit-button"
                        class="flex-1 btn-custom text-white font-medium py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] active:scale-[0.99]"
                        onclick="handleSubmitOrSkip()">
                    送出
                </button>
                
                <button id="next-button"
                        class="flex-1 btn-custom text-white font-medium py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] active:scale-[0.99] hidden"
                        onclick="nextQuestion()">
                    下一題
                </button>
            </div>
            <p id="user-id-display" class="text-xs text-gray-400 mt-4 text-center break-words">User ID: N/A</p>
        </div>
    </div>

    <!-- JavaScript 邏輯區塊 (使用 type="module" 支援 Firebase ES 模組) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 核心單字庫 (用於初始化)
        // *** 請將您的 3000 個單字列表替換到下方 BASE_VOCABULARY 變數中 ***
        const BASE_VOCABULARY = [
            { word: "apple", meaning: "蘋果", pos: "(n.)" },
            { word: "book", meaning: "書本", pos: "(n.)" },
            { word: "house", meaning: "房子", pos: "(n.)" },
            { word: "run", meaning: "跑", pos: "(v.)" },
            { word: "happy", meaning: "快樂的", pos: "(adj.)" },
            { word: "tree", meaning: "樹", pos: "(n.)" },
            { word: "water", meaning: "水", pos: "(n.)" },
            { word: "time", meaning: "時間", pos: "(n.)" },
            { word: "family", meaning: "家庭", pos: "(n.)" },
            { word: "understand", meaning: "理解", pos: "(v.)" },
            { word: "computer", meaning: "電腦", pos: "(n.)" },
            { word: "science", meaning: "科學", pos: "(n.)" },
            { word: "music", meaning: "音樂", pos: "(n.)" },
            { word: "travel", meaning: "旅行", pos: "(v.)" },
            { word: "beautiful", meaning: "美麗的", pos: "(adj.)" },
            { word: "develop", meaning: "發展", pos: "(v.)" },
            { word: "success", meaning: "成功", pos: "(n.)" },
            { word: "system", meaning: "系統", pos: "(n.)" },
            { word: "example", meaning: "範例", pos: "(n.)" },
            { word: "global", meaning: "全球的", pos: "(adj.)" },
            { word: "knowledge", meaning: "知識", pos: "(n.)" },
            { word: "important", meaning: "重要的", pos: "(adj.)" },
            { word: "language", meaning: "語言", pos: "(n.)" },
            { word: "believe", meaning: "相信", pos: "(v.)" },
            { word: "difference", meaning: "差異", pos: "(n.)" },
            // 在此處加入更多單字以達到 3000 個，格式保持一致
            { word: "algorithm", meaning: "演算法", pos: "(n.)" },
            { word: "protocol", meaning: "協定", pos: "(n.)" },
            { word: "efficient", meaning: "效率高的", pos: "(adj.)" },
        ];

        // --- 應用程式狀態 ---
        let db, auth;
        let userId = 'N/A';
        let firestoreReady = false;
        
        let currentWord = null;
        let currentDirection = ''; 
        let score = 0;
        let totalQuestions = 0;
        let isQuestionAnswered = false;
        
        // 儲存從 Firestore 載入或初始化的帶有統計數據的單字列表
        let fullVocabularyStats = []; 

        // --- Firebase 配置與環境變數處理 ---

        // ==============================================================================
        //  !!! 重要設定區 !!!
        //  如果您將此文件匯出並作為獨立網頁運行 (例如在 GitHub Pages 上)，
        //  請務必將下方的 "YOUR_..." 佔位符替換為您自己 Firebase 專案的實際配置！
        // ==============================================================================
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID", 
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // 如果在 Canvas 外部運行，這是用於 Firestore 路徑的預設 App ID。
        const CUSTOM_FALLBACK_APP_ID = "standalone-vocab-quiz"; 

        // 2. 決定最終使用的變數：優先使用 Canvas 環境變數 (以 `__` 開頭)，否則使用自訂配置。
        const hasCanvasConfig = typeof __firebase_config !== 'undefined' && __firebase_config;
        
        const firebaseConfig = hasCanvasConfig 
                               ? JSON.parse(__firebase_config) 
                               : CUSTOM_FIREBASE_CONFIG;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : CUSTOM_FALLBACK_APP_ID;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- Firebase 配置與環境變數處理結束 ---

        // --- UI 元素 ---
        const questionDisplay = document.getElementById('quiz-question');
        const directionDisplay = document.getElementById('quiz-direction');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('submit-button');
        const nextButton = document.getElementById('next-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const scoreDisplay = document.getElementById('score-display');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');
        const quizCard = document.getElementById('quiz-card');
        const answerDisplay = document.getElementById('correct-answer-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const modeInfoDisplay = document.getElementById('mode-info');

        /**
         * 取得 Firestore 文件參考路徑 (私有資料)
         */
        function getStatsDocRef() {
            // Path: /artifacts/{appId}/users/{userId}/vocabulary_stats/global
            return doc(db, 'artifacts', appId, 'users', userId, 'vocabulary_stats', 'global');
        }

        /**
         * 啟動純離線模式（當 Firebase 無法使用時）
         */
        function initOffline() {
            modeInfoDisplay.textContent = '純離線模式，無法儲存進度。';
            userIdDisplay.textContent = 'User ID: OFFLINE_MODE (無法儲存紀錄)';
            fullVocabularyStats = BASE_VOCABULARY; // 使用無統計數據的靜態單字庫
            if (fullVocabularyStats.length > 0) {
                selectNextQuestion();
                setupListeners();
            } else {
                questionDisplay.textContent = "單字庫為空，無法開始測驗。";
            }
        }

        /**
         * 載入並監聽 Firestore 數據
         */
        function loadAndListenToData() {
            if (!db || !userId) return;

            const docRef = getStatsDocRef();
            
            // 設置即時監聽
            onSnapshot(docRef, (docSnap) => {
                let data;
                if (docSnap.exists()) {
                    data = docSnap.data();
                    console.log("Current data from Firestore:", data);
                    // 載入主要統計數據
                    score = data.score || 0;
                    totalQuestions = data.totalQuestions || 0;
                    
                    // 載入單字統計，確保結構與 BASE_VOCABULARY 一致
                    // 如果數據庫中沒有，則初始化
                    fullVocabularyStats = data.vocabulary || BASE_VOCABULARY.map(w => ({
                        ...w,
                        correctCount: 0,
                        incorrectCount: 0,
                    }));
                    
                    // 確保 BASE_VOCABULARY 中的所有單字都在統計列表中（防止單字庫更新）
                    BASE_VOCABULARY.forEach(baseWord => {
                        if (!fullVocabularyStats.find(w => w.word === baseWord.word)) {
                            fullVocabularyStats.push({
                                ...baseWord,
                                correctCount: 0,
                                incorrectCount: 0,
                            });
                        }
                    });

                } else {
                    console.log("No existing stats found. Initializing new stats and saving.");
                    // 初始化並儲存預設統計結構
                    fullVocabularyStats = BASE_VOCABULARY.map(w => ({
                        ...w,
                        correctCount: 0,
                        incorrectCount: 0,
                    }));
                    saveData(); // 立即儲存初始狀態
                }

                // 更新 UI 顯示
                scoreDisplay.textContent = score;
                totalQuestionsDisplay.textContent = totalQuestions;

                // 如果是第一次載入，開始測驗
                if (!currentWord) {
                    selectNextQuestion();
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                initOffline(); // 監聽失敗則退回離線模式
            });
        }

        /**
         * 將當前狀態儲存到 Firestore
         */
        async function saveData() {
            if (!firestoreReady) {
                console.error("Firestore not ready. Cannot save data.");
                return;
            }
            const docRef = getStatsDocRef();
            const dataToSave = {
                score: score,
                totalQuestions: totalQuestions,
                vocabulary: fullVocabularyStats,
                lastUpdated: new Date().toISOString()
            };
            try {
                // 使用 setDoc + merge: true 來確保不會覆蓋其他欄位 (雖然這裡只有這個文件)
                await setDoc(docRef, dataToSave, { merge: true });
                console.log("Data saved successfully.");
            } catch (e) {
                console.error("Error writing document: ", e);
            }
        }

        /**
         * 應用程式啟動 (主函數)
         */
        async function initApp() {
            modeInfoDisplay.textContent = '正在驗證身分並同步數據...';
            setupListeners();
            
            // 檢查 Firebase 配置是否完整 (不論是 Canvas 提供的還是自訂的)
            // 獨立模式下，檢查 CUSTOM_FIREBASE_CONFIG 是否還有 YOUR_... 佔位符
            const isCustomConfigUsed = !hasCanvasConfig;
            const isPlaceholder = Object.values(firebaseConfig).some(val => typeof val === 'string' && val.includes('YOUR_'));
            
            if (isCustomConfigUsed && isPlaceholder) {
                console.warn("Firebase config still contains placeholders. Switching to offline mode.");
                return initOffline();
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('error'); // 減少控制台噪音，只顯示錯誤

                // 1. 處理身份驗證
                // 優先使用 Canvas 提供的 Custom Token，否則使用匿名登入 (適用於獨立網頁)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. 監聽身份狀態變化
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        firestoreReady = true;
                        // 檢查是否使用自訂配置
                        const modeText = hasCanvasConfig 
                                        ? '您的分數和進度將被自動儲存。' 
                                        : '使用自訂 Firebase 儲存。 (請確保安全規則正確)';
                        modeInfoDisplay.textContent = modeText;
                        loadAndListenToData(); // 身份驗證成功後開始載入數據
                    } else {
                        console.error("Authentication failed. Running in OFFLINE_MODE.");
                        initOffline();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // 檢查是否是配置錯誤導致的初始化失敗
                if (isCustomConfigUsed && error.code === 'auth/invalid-api-key') {
                     modeInfoDisplay.textContent = '錯誤：API 金鑰無效。請檢查您的 CUSTOM_FIREBASE_CONFIG。';
                }
                initOffline();
            }
        }

        /**
         * 選擇下一題的單字與抽查方向
         */
        function selectNextQuestion() {
            if (fullVocabularyStats.length === 0) {
                questionDisplay.textContent = "單字庫為空。";
                return;
            }

            // --- 智慧選題邏輯 (加權隨機) ---
            let totalWeight = 0;
            const weightedWords = fullVocabularyStats.map(word => {
                const C = word.correctCount || 0;
                const I = word.incorrectCount || 0;
                let weight;

                if (C === 0 && I === 0) {
                    // 1. 全新單字：給予高權重 (5)，確保新單字能優先被抽到
                    weight = 5; 
                } else {
                    // 2. 已學習單字：
                    // 公式: Max(1, 1 + 5*I - 1*C)
                    // - 答錯次數 (I) 權重 +5 (優先複習)
                    // - 答對次數 (C) 權重 -1 (降低已掌握單字的出現頻率)
                    // - 最低權重為 1
                    weight = Math.max(1, 1 + (5 * I) - C);
                }
                
                totalWeight += weight;
                return { word: word, weight: weight };
            });

            // 隨機選擇一個單字 (輪盤法)
            let randomTarget = Math.random() * totalWeight;
            let selectedWord = null;

            for (const item of weightedWords) {
                randomTarget -= item.weight;
                if (randomTarget <= 0) {
                    selectedWord = item.word;
                    break;
                }
            }
            
            // 如果出錯或總權重為零，則退回隨機選取
            currentWord = selectedWord || fullVocabularyStats[Math.floor(Math.random() * fullVocabularyStats.length)];
            // --- 智慧選題邏輯結束 ---
            
            // 2. 隨機決定方向 (英翻中 E2C, 中翻英 C2E)
            currentDirection = Math.random() < 0.5 ? 'E2C' : 'C2E';

            // 3. 渲染題目並重設 UI 狀態
            renderQuestion(currentWord);

            answerInput.value = '';
            answerInput.disabled = false;
            submitButton.disabled = false;
            submitButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            feedbackMessage.classList.add('hidden');
            answerDisplay.classList.add('hidden');
            quizCard.classList.remove('correct-feedback-bg', 'incorrect-feedback-bg', 'skip-feedback-bg'); 
            quizCard.classList.add('quiz-card-theme'); 
            isQuestionAnswered = false;
            
            answerInput.focus();
        }

        /**
         * 渲染當前題目到畫面上
         */
        function renderQuestion(wordObject) {
            const posDisplay = wordObject.pos ? `<span class="text-2xl opacity-80 font-normal">${wordObject.pos}</span>` : '';
            const currentDirectionText = currentDirection === 'E2C' ? '【英翻中】' : '【中翻英】';
            
            if (currentDirection === 'E2C') {
                directionDisplay.textContent = currentDirectionText;
                questionDisplay.innerHTML = `${wordObject.word} ${posDisplay}`; 
                answerInput.placeholder = '請輸入中文解釋...';
            } else {
                directionDisplay.textContent = currentDirectionText; 
                questionDisplay.innerHTML = `${wordObject.meaning} ${posDisplay}`; 
                answerInput.placeholder = '請輸入英文單字...';
            }
        }

        /**
         * 處理 送出答案 / 跳過 邏輯
         */
        window.handleSubmitOrSkip = function() {
            if (isQuestionAnswered || !currentWord) return;

            const userAnswer = answerInput.value.trim();
            const currentWordStat = currentWord;
            let correctAnswer;

            if (currentDirection === 'E2C') {
                correctAnswer = currentWordStat.meaning; 
            } else {
                correctAnswer = currentWordStat.word;    
            }

            const isSkipped = userAnswer === '';
            // 由於跳過會讓 userAnswer === ''，這裡確保跳過時不算正確或錯誤
            const isCorrect = isSkipped ? false : validateAnswer(userAnswer, correctAnswer, currentDirection);

            totalQuestions++;
            
            isQuestionAnswered = true;
            answerInput.disabled = true;
            submitButton.classList.add('hidden');
            nextButton.classList.remove('hidden');
            feedbackMessage.classList.remove('hidden');
            answerDisplay.classList.remove('hidden');
            quizCard.classList.remove('quiz-card-theme');

            // 1. 更新單字統計
            const wordToUpdate = fullVocabularyStats.find(w => w.word === currentWordStat.word);
            if (wordToUpdate) {
                if (isCorrect) {
                    score++;
                    wordToUpdate.correctCount = (wordToUpdate.correctCount || 0) + 1;
                } else {
                    // 無論是答錯 (isSkipped=false) 或跳過 (isSkipped=true)，都計入 incorrectCount (待複習)
                    wordToUpdate.incorrectCount = (wordToUpdate.incorrectCount || 0) + 1;
                }
            }


            // 2. 儲存數據 (會觸發 onSnapshot 更新 UI)
            if (firestoreReady) {
                saveData();
            } else {
                scoreDisplay.textContent = score;
                totalQuestionsDisplay.textContent = totalQuestions;
            }

            // 3. 顯示結果
            if (isSkipped) {
                feedbackMessage.textContent = '⏭️ 已跳過，請看下方正確答案。';
                feedbackMessage.classList.remove('correct-feedback-text', 'incorrect-feedback-text'); 
                feedbackMessage.classList.add('skip-feedback-text');
                quizCard.classList.add('skip-feedback-bg');
            } else if (isCorrect) {
                feedbackMessage.textContent = '✅ 太棒了，答案正確！';
                feedbackMessage.classList.remove('incorrect-feedback-text', 'skip-feedback-text');
                feedbackMessage.classList.add('correct-feedback-text'); 
                quizCard.classList.add('correct-feedback-bg'); 
            } else {
                feedbackMessage.textContent = '❌ 錯誤！請看下方正確答案。';
                feedbackMessage.classList.remove('correct-feedback-text', 'skip-feedback-text');
                feedbackMessage.classList.add('incorrect-feedback-text');
                quizCard.classList.add('incorrect-feedback-bg');
            }

            // 4. 顯示正確答案
            const correctPOS = currentWordStat.pos;
            answerDisplay.innerHTML = `正確答案：<span class="font-black">${correctAnswer}</span> <span class="text-base font-normal opacity-70">${correctPOS}</span>`;

            answerInput.focus();
        }

        /**
         * 進行下一題
         */
        window.nextQuestion = function() {
            selectNextQuestion();
        }

        /**
         * 答案驗證邏輯
         */
        function validateAnswer(user, correct, direction) {
            if (direction === 'C2E') {
                // 英文：不分大小寫
                return user.toLowerCase() === correct.toLowerCase();
            } else {
                // 中文：先清除空格和標點符號，再檢查部分重疊或完全相等
                const cleanUser = user.replace(/[\s\.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").trim();
                const cleanCorrect = correct.replace(/[\s\.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").trim();
                // 這裡我們採用精確匹配，若需要模糊匹配則需要更複雜的邏輯
                return cleanUser === cleanCorrect;
            }
        }
        
        /**
         * 初始化事件監聽器
         */
        function setupListeners() {
            // 允許在輸入框中按 Enter 鍵觸發送出或下一題
            answerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!isQuestionAnswered) {
                        window.handleSubmitOrSkip();
                    } else {
                        window.nextQuestion();
                    }
                }
            });
        }

        // 應用程式啟動
        window.onload = initApp;
    </script>
</body>
</html>
